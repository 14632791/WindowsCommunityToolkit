<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        html, body {
            border: 0px;
            margin: 0px;
            height: 100%;
            font-family: 'Segoe UI Web Light', 'Segoe UI Light', 'Segoe WP Light', 'Segoe UI', 'Segoe WP', Tahoma, Arial, sans-serif;
            overflow: hidden;
        }

        #dropdownContainer {
            position: absolute;
            left: 10px;
            top: 10px;
        }

            #dropdownContainer select {
                margin-right: 15px;
                padding: 3px;
                font-size: 1em;
            }

        #reportContainer {
            height: 100%;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://npmcdn.com/es6-promise@3.2.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/powerbi-client@2.5.1/dist/powerbi.min.js"></script>
</head>
<body>
    <div id="dropdownContainer" style="visibility:hidden">
        <select id="reportsDropdown" style="display:none">
            <option>Loading</option>
        </select>
        <select id="pagesDropdown"></select>
        <select id="visualsDropdown" style="display:none"></select>
    </div>
    <div id="reportContainer"></div>

    <script>
        var accessToken;

        function getReport() {
            const embedContainer = $('#reportContainer')[0];
            return powerbi.get(embedContainer);
        }

        function refreshToken(token) {
            const report = getReport();
            accessToken = token;
            report.setAccessToken(token);
        }

        function loadGroups(token, reports, selectionReport) {
            accessToken = token;
            $('#dropdownContainer').css('visibility', 'visible')
            $('#reportsDropdown').off("change").html('');

            if (reports.length == 1) {
                $('#reportsDropdown').hide();
            }
            else {
                $('#reportsDropdown').show();
            }

            reports.forEach(function (report) {
                if (report.id == selectionReport.id) {
                    $('#reportsDropdown').append(`<option value='${report.id}' selected>${report.name}</option>`);
                }
                else {
                    $('#reportsDropdown').append(`<option value='${report.id}'>${report.name}</option>`);
                }
            });

            $('#reportsDropdown').on("change", (function (reports) {
                return function () {
                    var id = $(this).val();
                    var findReport = reports.find(function (report) {
                        return report.id == id;
                    });
                    loadPowerBiReport(findReport);

                };
            })(reports));

            loadPowerBiReport(selectionReport);
        }

        function loadPowerBiReport(embedReport) {
            const models = window['powerbi-client'].models;

            const config = {
                type: 'report',
                tokenType: models.TokenType.Aad,
                accessToken: accessToken,
                embedUrl: embedReport.embedUrl,
                id: embedReport.id,
                permissions: models.Permissions.All,
                settings: {
                    filterPaneEnabled: true,
                    navContentPaneEnabled: false
                }
            };
            const report = powerbi.embed(reportContainer, config);

            $('#reportContainer').css('visibility', 'visible');
            $('#pagesDropdown').off("change").html('<option>Loading</option>');
            $('#visualsDropdown').off("change").html('<option>Loading</option>');

            report.off("loaded");
            report.on("loaded", function () {
                loadPages();
            });
        }

        function loadPages() {
            var report = getReport();

            report.getPages()
                .then(function (pages) {
                    $('#pagesDropdown').html('');

                    pages.forEach(function (page) {
                        $('#pagesDropdown').append(`<option value='${page.name}'>${page.displayName}</option>`);
                    });

                    $('#pagesDropdown').on("change", (function (pages) {
                        return function () {
                            var name = $(this).val();
                            var findPage = pages.find(function (page) {
                                return page.name == name;
                            });

                            $('#visualsDropdown').off("change").html('<option>Loading</option>');

                            findPage.setActive();
                            loadVisuals(findPage);
                        };
                    })(pages));

                    report.off("pageChanged");

                    report.on("pageChanged", function (event) {
                        var page = event.detail.newPage;
                        if ($('#pagesDropdown').val() != page.name) {
                            $('#pagesDropdown').val(page.name);
                            $('#pagesDropdown').change();
                        }
                    });

                    loadVisuals(pages[0]);
                })
                .catch(function (error) {
                    alert(error);
                });
        }

        function loadVisuals(page) {
            page.getVisuals()
                .then(function (visuals) {
                    $('#visualsDropdown').html('<option>All</option>');

                    visuals.forEach(function (visual) {
                        $('#visualsDropdown').append(`<option value='${visual.name}'>${visual.title || 'No title'}</option>`);
                    });

                    $('#visualsDropdown').on("change", (function (visuals) {
                        return function () {
                            const models = window['powerbi-client'].models;
                            const name = $(this).val();
                            const findVisual = visuals.find(function (visual) {
                                return visual.name == name;
                            });

                            let pageLayout = {
                                defaultLayout: {
                                    displayState: {
                                        mode: models.VisualContainerDisplayMode.Hidden
                                    }
                                },
                                visualsLayout: {}
                            };

                            if (name == 'All') {
                                visuals.forEach(function (visual) {
                                    pageLayout.visualsLayout[visual.name] = {
                                        displayState: {
                                            mode: models.VisualContainerDisplayMode.Visible
                                        }
                                    };
                                });
                            }
                            else {
                                pageLayout.visualsLayout[findVisual.name] = {
                                    displayState: {
                                        mode: models.VisualContainerDisplayMode.Visible
                                    }
                                };
                            }

                            let settings = {
                                filterPaneEnabled: true,
                                navContentPaneEnabled: false,
                                layoutType: models.LayoutType.Custom,
                                customLayout: {
                                    pageSize: {
                                        type: models.PageSizeType.Widescreen
                                    },
                                    displayOption: models.DisplayOption.FitToPage,
                                    pagesLayout: {}
                                }
                            }

                            settings.customLayout.pagesLayout[visuals[0].page.name] = pageLayout;

                            const report = getReport();

                            report.updateSettings(settings)
                                .catch(function (error) {
                                    alert(error);
                                });

                        };
                    })(visuals));
                })
                .catch(function (errors) {
                    alert(errors);
                });
        }

        function clearReport() {
            $('#dropdownContainer').css('visibility', 'hidden');
            $('#reportContainer').css('visibility', 'hidden');
            $('#pagesDropdown').html('');
            $('#visualsDropdown').html('');
        }
    </script>
</body>
</html>
