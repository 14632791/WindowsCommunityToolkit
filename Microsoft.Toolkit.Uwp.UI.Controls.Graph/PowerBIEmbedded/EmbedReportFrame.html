<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title></title>
    <style>
        html, body {
            border: 0px;
            margin: 0px;
            height: 100%;
            font-family: 'Segoe UI Web Light', 'Segoe UI Light', 'Segoe WP Light', 'Segoe UI', 'Segoe WP', Tahoma, Arial, sans-serif;
            overflow: hidden;
        }
        #dropdownContainer {
            position: absolute;
            left: 10px;
            top: 10px;
        }
        #dropdownContainer select {
            margin-right: 15px;
            padding: 3px;
            font-size: 1em;
        }
        #reportContainer {
            height: 100%;
        }

        @media (max-width: 720px) {
            #dropdownContainer {
                position: static;
            }
            #dropdownContainer select {
                width: 100%;
            }
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://npmcdn.com/es6-promise@3.2.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/powerbi-client@2.5.1/dist/powerbi.min.js"></script>
</head>
<body>
    <div id="dropdownContainer" style="visibility:hidden">
        <select id="reportsDropdown" style="display:none">
            <option>Loading</option>
        </select>
        <select id="pagesDropdown"></select>
    </div>
    <div id="reportContainer"></div>

    <script>
        var accessToken;
        var currentOrientation;

        function getReport() {
            const embedContainer = $('#reportContainer')[0];
            return powerbi.get(embedContainer);
        }

        function refreshToken(token) {
            const report = getReport();
            accessToken = token;
            report.setAccessToken(token);
        }

        function loadGroups(token, reports, defaultReport, orientation) {
            accessToken = token;
            currentOrientation = orientation ;

            $('#dropdownContainer').css('visibility', 'visible')
            $('#reportsDropdown').off("change").html('');

            if (reports.length == 1) {
                $('#reportsDropdown').hide();
            }
            else {
                $('#reportsDropdown').show();
            }

            reports.forEach(function (report) {
                if (report.id == defaultReport.id) {
                    $('#reportsDropdown').append(`<option value='${report.id}' selected>${report.name}</option>`);
                }
                else {
                    $('#reportsDropdown').append(`<option value='${report.id}'>${report.name}</option>`);
                }
            });

            $('#reportsDropdown').on("change", (function (reports) {
                return function () {
                    var id = $(this).val();
                    var selectedReport = reports.find(function (report) {
                        return report.id == id;
                    });

                    loadReport(selectedReport);
                };
            })(reports));

            loadReport(defaultReport);
        }

        function loadReport(embedReport) {
            const models = window['powerbi-client'].models;

            const config = {
                type: 'report',
                tokenType: models.TokenType.Aad,
                accessToken: accessToken,
                embedUrl: embedReport.embedUrl,
                id: embedReport.id,
                permissions: models.Permissions.All,
                settings: getSettings()
            };
            const report = powerbi.embed(reportContainer, config);

            $('#reportContainer').css('visibility', 'visible');
            $('#pagesDropdown').off("change").html('<option>Loading</option>');

            report.off("loaded");
            report.on("loaded", function () {
                loadPages();
            });
        }

        function loadPages() {
            var report = getReport();

            report.getPages()
                .then(function (pages) {
                    $('#pagesDropdown').html('');

                    pages.forEach(function (page) {
                        $('#pagesDropdown').append(`<option value='${page.name}'>${page.displayName}</option>`);
                    });

                    $('#pagesDropdown').on("change", (function (pages) {
                        return function () {
                            var name = $(this).val();
                            var findPage = pages.find(function (page) {
                                return page.name == name;
                            });

                            findPage.setActive();
                        };
                    })(pages));

                    report.off("pageChanged");
                    report.on("pageChanged", function (event) {
                        var page = event.detail.newPage;
                        if ($('#pagesDropdown').val() != page.name) {
                            $('#pagesDropdown').val(page.name);
                            $('#pagesDropdown').change();
                        }
                    });
                })
                .catch(function (error) {
                    alert(error);
                });
        }

        function rotate(orientation) {
            // do rotate only when the report is already loaded previously
            if (!currentOrientation) {
                return;
            }

            currentOrientation = orientation;

            const settings = getSettings();

            const report = getReport();

            report.updateSettings(settings)
                .then(function () {

                })
                .catch(function (error) {
                    alert(error);
                });
        }

        function getSettings() {
            const models = window['powerbi-client'].models;

            switch (currentOrientation) {
                case 'Portrait':
                case 'PortraitFlipped':
                    return {
                        layoutType: models.LayoutType.MobilePortrait
                    };
                case 'Landscape':
                case 'LandscapeFlipped':
                    return {
                        layoutType: models.LayoutType.MobileLandscape
                    };
                default:
                    return {
                        filterPaneEnabled: true,
                        navContentPaneEnabled: false
                    };
            }
        }

        function clearReport() {
            $('#dropdownContainer').css('visibility', 'hidden');
            $('#reportContainer').css('visibility', 'hidden');
            $('#pagesDropdown').html('');
        }
        
    </script>
</body>
</html>
