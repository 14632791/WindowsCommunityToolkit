<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title></title>
    <style>
        html, body {
            border: 0px;
            margin: 0px;
            height: 100%;
            font-family: 'Segoe UI Web Light', 'Segoe UI Light', 'Segoe WP Light', 'Segoe UI', 'Segoe WP', Tahoma, Arial, sans-serif;
            overflow: hidden;
        }
        #dropdownContainer {
            position: absolute;
            left: 10px;
            top: 10px;
        }
        #dropdownContainer select {
            margin-right: 15px;
            padding: 3px;
            font-size: 1em;
            display: inline-block;
        }
        #reportContainer {
            height: 100%;
        }

        @media (max-width: 720px) {
            #dropdownContainer {
                position: static;
            }
            #dropdownContainer select {
                width: 100%;
                display: block;
            }
        }
    </style>
    <script src="powerbi.min.js"></script>
</head>
<body>
    <div id="dropdownContainer" style="visibility:hidden">
        <select id="reportsDropdown" style="display:none">
            <option>Loading</option>
        </select>
        <select id="pagesDropdown"></select>
    </div>
    <div id="reportContainer"></div>

    <script>
        var accessToken;
        var currentOrientation;

        function getReport() {
            const embedContainer = document.getElementById('reportContainer');
            return powerbi.get(embedContainer);
        }

        function refreshToken(token) {
            const report = getReport();
            accessToken = token;
            report.setAccessToken(token);
        }

        function loadGroups(token, reports, defaultReport, orientation) {
            accessToken = token;
            currentOrientation = orientation ;

            document.getElementById('dropdownContainer').style.visibility = 'visible';

            var reportsDDL = resetDropdown('reportsDropdown');

            reportsDDL.style.display = reports.length == 1 ? 'none' : 'inline-block';

            reports.forEach(function (report) {
                if (report.id == defaultReport.id) {
                    reportsDDL.innerHTML += `<option value='${report.id}' selected>${report.name}</option>`;
                }
                else {
                    reportsDDL.innerHTML += `<option value='${report.id}'>${report.name}</option>`;
                }
            });

            reportsDDL.addEventListener('change', function (e) {
                var id = e.target.value;
                var selectedReport = reports.find(function (report) {
                    return report.id == id;
                });

                if (selectedReport) {
                    loadReport(selectedReport);
                }
            });

            loadReport(defaultReport);
        }

        function loadReport(embedReport) {
            const models = window['powerbi-client'].models;

            const config = {
                type: 'report',
                tokenType: models.TokenType.Aad,
                accessToken: accessToken,
                embedUrl: embedReport.embedUrl,
                id: embedReport.id,
                permissions: models.Permissions.All,
                settings: getSettings()
            };
            const report = powerbi.embed(reportContainer, config);

            document.getElementById('reportContainer').style.visibility = 'visible';

            var pagesDDL = resetDropdown('pagesDropdown', '<option>Loading</option>');

            report.off("loaded");
            report.on("loaded", function () {
                loadPages();
            });
        }

        function loadPages() {
            var report = getReport();

            report.getPages()
                .then(function (pages) {
                    var pagesDDL = resetDropdown('pagesDropdown');
                    pages.forEach(function (page) {
                        pagesDDL.innerHTML += `<option value='${page.name}'>${page.displayName}</option>`;
                    });

                    pagesDDL.addEventListener('change', function (e) {
                        var name = e.target.value;
                        var findPage = pages.find(function (page) {
                            return page.name == name;
                        });

                        if (findPage) {
                            findPage.setActive();
                        }
                    });

                    report.off("pageChanged");
                    report.on("pageChanged", function (event) {
                        var page = event.detail.newPage;

                        if (pagesDDL.value != page.name) {
                            pagesDDL.value = page.name;
                            triggerEvent(pagesDDL, 'change');
                        }
                    });
                })
                .catch(function (error) {
                    alert(error);
                });
        }

        function rotate(orientation) {
            // do rotate only when the report is already loaded previously
            if (!currentOrientation) {
                return;
            }

            currentOrientation = orientation;

            const settings = getSettings();

            const report = getReport();

            report.updateSettings(settings)
                .then(function () {

                })
                .catch(function (error) {
                    alert(error);
                });
        }

        function getSettings() {
            const models = window['powerbi-client'].models;

            switch (currentOrientation) {
                case 'Portrait':
                case 'PortraitFlipped':
                    return {
                        layoutType: models.LayoutType.MobilePortrait
                    };
                case 'Landscape':
                case 'LandscapeFlipped':
                    return {
                        layoutType: models.LayoutType.MobileLandscape
                    };
                default:
                    return {
                        filterPaneEnabled: true,
                        navContentPaneEnabled: false
                    };
            }
        }

        function clearReport() {
            document.getElementById('dropdownContainer').style.visibility = 'hidden';
            document.getElementById('reportContainer').style.visibility = 'hidden';

            resetDropdown('pagesDropdown');
        }

        function resetDropdown(elemId, innerHTML) {
            var elem = document.getElementById(elemId);

            // clone and replace node to remove all events
            var elemTemp = elem.cloneNode();
            elem.parentNode.replaceChild(elemTemp, elem);
            elem = elemTemp;

            // reset inner HTML
            elem.innerHTML = innerHTML || '';

            return elem;
        }

        function triggerEvent(elem, event) {
            if ("createEvent" in document) {
                var evt = document.createEvent("HTMLEvents");
                evt.initEvent(event, false, true);
                elem.dispatchEvent(evt);
            }
            else {
                elem.fireEvent("on" + event);
            }
        }

    </script>
</body>
</html>
